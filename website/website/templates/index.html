<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Weather Dashboard</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />

</head>
<body>

<!-- Map container -->
<div id="map"></div>

<!-- Status board -->
<div id="status-board" class="visible">
    <div id="status-toggle">&raquo;</div>
    <div id="status-content">
        <!-- Content injected via JS -->
    </div>
</div>

<!-- Modal template -->
<div class="modal" id="modal">
    <div class="modal-content">
        <button class="modal-close" id="modal-close">
            <img src="{{ url_for('static', filename='close-x-svgrepo-com.svg') }}" alt="Close">
        </button>
        <h2 class="modal-title"></h2>
        <div class="modal-text" id="modal-text">
            <!-- rows injected here -->
        </div>
        <div class="chart-container">
            <canvas id="temperatureChart"></canvas>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
	
/* Initialize map */
const map = L.map('map', {
    maxBounds: [[54.45, 7.85], [57.95, 15.25]],
    maxBoundsViscosity: 1.0,
    minZoom: 7,
    maxZoom: 15
}).setView([56.0, 10.0], 7);

L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; <a href="https://www.carto.com/">CARTO</a>',
    subdomains: 'abcd',
    maxZoom: 19
}).addTo(map);


/* Custom marker icon */
const redIcon = L.icon({
    iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34],
    shadowSize: [41, 41]
});

/* Modal logic */
const modal = document.getElementById('modal');
const modalClose = document.getElementById('modal-close');
const modalTitle = modal.querySelector('.modal-title');
const modalText = document.getElementById('modal-text');
let temperatureChart; // Chart.js instance

modalClose.addEventListener('click', () => modal.style.display = 'none');
modal.addEventListener('click', e => { if (e.target === modal) modal.style.display = 'none'; });

function openModal(title, contentHtml) {
    modalTitle.textContent = title;
    modalText.innerHTML = contentHtml;
    modal.style.display = 'flex';
}

/* Draw temperature chart */
function drawTemperatureGraph(temperatures) {
    const ctx = document.getElementById('temperatureChart').getContext('2d');

    if (temperatureChart) temperatureChart.destroy();

    temperatureChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: Array.from({length: 24}, (_, i) => `${i}:00`),
            datasets: [{
                label: 'Temperature (°C)',
                data: temperatures,
                borderColor: 'red',
                backgroundColor: 'rgba(255,0,0,0.2)',
                fill: true,
                tension: 0.3,
                pointRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    ticks: { autoSkip: false },
                    title: {
                        display: true,
                        text: 'Time (hours)',
                        font: { size: 14, weight: 'bold' }
                    }
                },
                y: {
                    min: 0,
                    max: 30,
                    ticks: {
                        stepSize: 5,
                        callback: value => value + '°C'
                    },
                    title: {
                        display: true,
                        text: 'Temperature (°C)',
                        font: { size: 14, weight: 'bold' }
                    }
                }
            },
            plugins: {
                legend: { display: false },
                tooltip: { mode: 'index', intersect: false }
            }
        }
    });
}

/* Fetch city data and add markers */
fetch('/api/cities')
.then(res => res.json())
.then(cities => {
    cities.forEach(city => {
        L.marker([city.lat, city.lon], { icon: redIcon })
        .addTo(map)
		.on('click', () => {

			const today = new Date();
			today.setDate(today.getDate());
			const date = today.toISOString().split('T')[0]; 
			fetch(`/api/getgraphdata?date=${date}&city_id=${city.id}`)
				.then(res => res.json())
				.then(data => {
				// Map API data to temperature array for Chart.js
				const temperatures = data.map(d => d.avg_temp ?? 0);

				// Draw the chart with temperatures only
				drawTemperatureGraph(temperatures);
			})
			.catch(err => console.error('Failed to fetch weather data:', err));

			fetch(`/api/latest_weather_for_city?city_id=${city.id}`)
				.then(res => res.json())
				.then(data => {

				const temperature = data.temperature_celsius ?? "N/A";
				const wind = data.wind_speed_ms ? `${data.wind_speed_ms} m/s` : "N/A";
				const precipitation = data.weather_status ?? "N/A";
				const timeStr = data.recorded_at ?? "N/A";

				let lastUpdated = "N/A";
				if (timeStr !== "N/A") {
					const date = new Date(timeStr); // parse ISO string
					const hours = String(date.getHours() + 1).padStart(2, '0');
					const minutes = String(date.getMinutes()).padStart(2, '0');
					const day = String(date.getDate()).padStart(2, '0');
					const month = String(date.getMonth() + 1).padStart(2, '0'); // months are 0-indexed
					const year = date.getFullYear();
					
					lastUpdated = `${hours}:${minutes} ${day}/${month}-${year}`;
				}

				const lowestTemp = 15;
				const highestTemp = 28;
				const averageTemp = 22;
				const content = `
				<div class="columns-container">
					<div class="column1">
						<div class="row temperature-row">
							<div class="live-dot"></div>
							<div><b>&nbsp;&nbsp;&nbsp;Temperature:</b> ${temperature} °C</div>
						</div>
						<div class="row"><div><b>&nbsp;&nbsp;&nbsp;Wind:</b> ${wind}</div></div>
						<div class="row"><div><b>&nbsp;&nbsp;&nbsp;Precipitation:</b> ${precipitation}</div></div>
						<div class="row"><div><b>&nbsp;&nbsp;&nbsp;Last updated:</b> ${lastUpdated}</div></div>
					</div>
					<!--
					<div class="column2">
						<div class="row"><div><b>&nbsp;</b></div></div>
						<div class="row"><div><b>Lowest Temperature:</b> ${lowestTemp} °C</div></div>
						<div class="row"><div><b>Highest Temperature:</b> ${highestTemp} °C</div></div>
						<div class="row"><div><b>Average Temperature:</b> ${averageTemp} °C</div></div>
					</div>
					-->
				</div>
				`;
            openModal(city.name, content);
})
			
.catch(err => console.error('Failed to fetch weather data:', err));
        });
    });
})
.catch(err => console.error('Failed to load city data:', err));
const statusBoard = document.getElementById('status-board');
const statusToggle = document.getElementById('status-toggle');
const statusContent = document.getElementById('status-content');

/* Fetch monthly extremes for the status board */
function updateStatusBoard() {
const today = new Date();
const month = today.getMonth() + 1; // JS months 0-11
const year = today.getFullYear();

fetch(`/api/monthly_report?year=${year}&month=${month}`)
    .then(res => res.json())
    .then(data => {
        if (data.length === 0 || data.message) {
            renderStatusBoard({
                title: "Status for Denmark",
                lowestTemp: "N/A",
                highestTemp: "N/A"
            });
            return;
        }

        // Extract min/max across all weather_status rows
        let minTemp = Math.min(...data.map(d => d.min_temp ?? 999));
        let maxTemp = Math.max(...data.map(d => d.max_temp ?? -999));

        statusContent.innerHTML = `<h3>Status for Denmark</h3>
            <p>Lowest Temperature: ${minTemp} °C</p>
            <p>Highest Temperature: ${maxTemp} °C</p>`;
    })
    .catch(err => {
        console.error('Failed to fetch monthly report:', err);
        statusContent.innerHTML = `<h3>Status for Denmark</h3>
            <p>Lowest Temperature: N/A</p>
            <p>Highest Temperature: N/A</p>`;
    });

}

setInterval(updateStatusBoard, 1000 * 60 * 60);
/* Initial render */
updateStatusBoard();

/* Toggle slide */
statusToggle.addEventListener('click', () => {
statusBoard.classList.toggle('hidden');
statusToggle.innerHTML = statusBoard.classList.contains('hidden') ? '«' : '»';
});

/* Optional: auto-refresh every hour */
setInterval(updateStatusBoard, 1000 * 60 * 60);

/* Example of updating data dynamically */
function updateWeather(newData) {
    statusData = { ...statusData, ...newData };
    renderStatusBoard(statusData);
}

</script>
</body>
</html>